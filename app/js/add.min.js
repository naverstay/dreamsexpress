function rgb2hex(e){return e=e.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/),"#"+hex(e[1])+hex(e[2])+hex(e[3])}function hex(e){return isNaN(e)?"00":hexDigits[(e-e%16)/16]+hexDigits[e%16]}function removeProduct(e){var o=$('.rmProdBtn[data-id="'+e+'"]').closest(".orderRow"),r=o.next(".orderExpandRow");console.log(e,o,r),$.ajax({type:"delete",url:"/product/"+e,dataType:"json",data:{},beforeSend:function(e){},success:function(e){console.log(e,e.error),e.remove_done&&(o.remove(),r.remove(),confirmation_popup.dialog("close"),$(".successText").text("Товар удален."),success_popup.dialog("open"))},error:function(e,o,r){console.log(e,o,r)},complete:function(e){}})}$(function(e){e(".colorPicker").each(function(o){var r=e(this);r.ColorPicker({flat:!0})}),body.delegate(".addColor","click",function(){var o,r=e(this),t=e(r.attr("href"));if(t.length&&(o="#"+t.find(".colorpicker_hex input").val()),isHex(o)){var a=r.nextAll(".uploadPreview").append('<li class="prodColorItem"><div class="prod_preview" style="background:'+o+';"></div><span class="prod_rm_btn rmProdColor"></span></li>').prevAll("input"),n=a.val()+","+o;a.val(n.replace(/^,/,"")),a.validationEngine("validate")}return!1}).delegate(".rmProdColor","click",function(){var o,r=e(this),t=r.closest(".prodColorItem"),a=t.find(".prod_preview").css("background-color"),n=r.closest(".uploadPreview").prevAll("input");if(t.find("img").length){var i=t.find("img").attr("src");o=new RegExp(",?[/]?"+i.replace(/^\//,""),"ig"),e.ajax({type:"post",url:"/remove",dataType:"json",data:{remove:i},beforeSend:function(e){},success:function(e){console.log(e,e.error),t.remove(),n.val(n.val().replace(" ","").replace(o,"").replace(/^,/,"")),n.validationEngine("validate")},error:function(e,o,r){console.log(e,o,r)},complete:function(e){n.validationEngine("validate")}})}else a=isHex(a)?a:rgb2hex(a),o=new RegExp("(,?"+a+")|(,?"+a.replace(/([a-f0-9])([a-f0-9])/g,"$1")+")","ig"),n.val(n.val().replace(" ","").replace(o,"").replace(/^,/,"")),n.validationEngine("validate"),t.remove();return!1}).delegate(".rmProdPreview","click",function(){var o=e(this),r=o.closest(".prodPreviewItem"),t=r.find("img").attr("src"),a=o.closest(".uploadPreview").prevAll("input");return e.ajax({type:"post",url:"/remove",dataType:"json",data:{remove:t},beforeSend:function(e){},success:function(e){if(console.log(e,e.error),e.remove_done){r.remove();var o=new RegExp(",?[/]?"+t.replace(/^\//,""),"ig");a.val(a.val().replace(o,"").replace(/^,/,""))}},error:function(e,o,r){console.log(e,o,r)},complete:function(e){a.validationEngine("validate")}}),!1}).delegate(".rmProdBtn","click",function(){var o=e(this);return e(".confirmCaption").text("ВНИМАНИЕ!!!"),e(".confirmAction").attr("href",'javascript:removeProduct("'+o.attr("data-id")+'");'),e(".confirmText").html("Товар <b>"+o.attr("data-name")+"</b> будет удален.<br>Это действие не обратимо."),confirmation_popup.dialog("open"),!1}),e(".uploadInput").on("change",function(){for(var o=e(this),r=new FormData,t=0;t<o[0].files.length;t++)r.append("imgs",o[0].files[t]);setTimeout(function(){e.ajax({type:"post",url:"/upload/"+o.attr("data-context"),cache:!1,contentType:!1,processData:!1,dataType:"json",data:r,beforeSend:function(e){},success:function(r){if(console.log(r,r.error),r.upload_done){for(var t="",a=e('input[name="'+o.attr("data-target")+'"]'),n="",i=0;i<r.files.length;i++)n+=","+r.files[i],t+='<li class="prodPreviewItem"><div class="prod_preview"><img src="'+r.files[i]+'"></div><span class="prod_rm_btn rmProdPreview"></span></li>';if(o.attr("multiple"))a.val((a.val()+n).replace(/^,/,"")).nextAll(".uploadPreview").append(t);else{var l=a.val();a.nextAll(".uploadPreview").find(".prod_rm_btn").click(),a.val(l.length?l+","+n.replace(/^,/,""):n.replace(/^,/,"")).nextAll(".uploadPreview").html(t)}a.validationEngine("validate")}},error:function(e,o,r){console.log(e,o,r)},complete:function(e){}})},10)}),e(".addForm").on("submit",function(){var o=e(this),r=!1;if(!o.validationEngine("validate"))return!1;if(!r){var t=o.serialize();e(".preloader").fadeIn(1e3),e.ajax({type:o.attr("method"),url:o.attr("action"),dataType:"json",data:t,beforeSend:function(e){o.find(".saveBtn").attr("disabled","disabled")},success:function(o){console.log(o,o.error),e(".successText").text("Товар добавлен."),o.redirectTo?redirectTo(o.redirectTo):o.product_added?(e("#orders_table").append(o.prod_title).append(o.prod_info),success_popup.dialog("open")):o.update_failed?(e(".failText").html(o.fail_text),fail_popup.dialog("open")):(e(".failText").text("Что-то пошло не так"),fail_popup.dialog("open"))},error:function(e,o,r){console.log(e,o,r)},complete:function(r){o.find(".saveBtn").prop("disabled",null),e(".preloader").fadeOut(1e3)}})}return!1})});var hexDigits=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];